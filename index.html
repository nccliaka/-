<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>內城社區體驗預約系統</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #f2f4f8;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }

    .card {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }

    .card h2 {
      color: #34495e;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 12px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 6px;
    }

    fieldset {
      border: none;
      padding: 0;
      margin-bottom: 15px;
    }

    button {
      background-color: #3498db;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      display: block;
      margin: 30px auto;
    }

    button:hover {
      background-color: #2980b9;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1>內城社區體驗預約系統</h1>

  <div class="card">
    <label>訂購人姓名：<input type="text" id="name" required></label>
    <label>訂購人電話：<input type="text" id="phone" required></label>
    <label>預約日期：
      <input type="date" id="date" required onchange="updateDataKey()">
    </label>

    <fieldset>
      <legend><strong>預約項目</strong></legend>
      <label><input type="checkbox" value="牛車" onchange="toggleSections()"> 鐵牛車</label>
      <label><input type="checkbox" value="割稻飯" onchange="toggleSections()"> 割稻飯</label>
      <label><input type="checkbox" value="粿DIY" onchange="toggleSections()"> 紅龜粿/草仔粿 DIY</label>
    </fieldset>
  </div>

  <div class="card hidden" id="section-niuche">
    <h2>鐵牛車預約</h2>
    <label>牛車數量（每台限乘6人）：
      <input type="number" id="niuche-count" min="1" onchange="checkTimeslots()">
    </label>

    <fieldset>
      <legend>選擇時段：</legend>
      <div id="timeslots"></div>
    </fieldset>
  </div>

  <div class="card hidden" id="section-rice">
    <h2>割稻飯預約</h2>
    <label>體驗人數：
      <input type="number" id="rice-count" min="1">
    </label>
    <label>預約時間：
      <input type="time" id="rice-time">
    </label>
  </div>

  <div class="card hidden" id="section-diy">
    <h2>紅龜粿 / 草仔粿 DIY</h2>
    <label>體驗人數：
      <input type="number" id="diy-count" min="1">
    </label>
    <label>預約時間：
      <input type="time" id="diy-time">
    </label>
  </div>

  <button onclick="submitForm()">送出表單</button>

  <script>
    const arr = {};
    let DATA = "00000000";
    let N = 0;

    function updateDataKey() {
      const date = document.getElementById("date").value;
      if (date) {
        DATA = date.replaceAll("-", "");
        if (!arr[DATA]) {
          arr[DATA] = [0, 30, 30, 30, 30]; // 預設每個時段 30 台牛車
        }
        checkTimeslots();
      }
    }

    function toggleSections() {
      const checkboxes = document.querySelectorAll('input[type=checkbox]');
      document.getElementById("section-niuche").classList.add("hidden");
      document.getElementById("section-rice").classList.add("hidden");
      document.getElementById("section-diy").classList.add("hidden");

      checkboxes.forEach(box => {
        if (box.checked) {
          if (box.value === "牛車") document.getElementById("section-niuche").classList.remove("hidden");
          if (box.value === "割稻飯") document.getElementById("section-rice").classList.remove("hidden");
          if (box.value === "粿DIY") document.getElementById("section-diy").classList.remove("hidden");
        }
      });
    }

    function checkTimeslots() {
      const count = parseInt(document.getElementById("niuche-count").value) || 0;
      N = count;
      if (!arr[DATA]) return;

      const slots = ["08:30~10:30", "10:30~12:30", "13:00~15:00", "15:00~17:00"];
      const container = document.getElementById("timeslots");
      container.innerHTML = "";

      for (let i = 1; i <= 4; i++) {
        const remain = arr[DATA][i];
        const disabled = remain < N ? "disabled" : "";
        container.innerHTML += `
          <label>
            <input type="radio" name="niuche-time" value="${i}" ${disabled}>
            時段${i} ${slots[i - 1]}（剩餘牛車數：${remain}）
          </label><br>`;
      }
    }

    function submitForm() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const date = document.getElementById("date").value;

      if (!name || !phone || !date) {
        alert("請填寫姓名、電話與日期！");
        return;
      }

      const formData = { name, phone, date };

      if (!document.getElementById("section-niuche").classList.contains("hidden")) {
        const niucheCount = parseInt(document.getElementById("niuche-count").value);
        const timeChoice = document.querySelector('input[name="niuche-time"]:checked');
        if (!niucheCount || !timeChoice) {
          alert("請完整填寫牛車預約！");
          return;
        }
        const slot = parseInt(timeChoice.value);
        if (arr[DATA][slot] < niucheCount) {
          alert("牛車數量不足！");
          return;
        }
        formData.niucheCount = niucheCount;
        formData.niucheSlot = slot;
      }

      if (!document.getElementById("section-rice").classList.contains("hidden")) {
        const riceCount = document.getElementById("rice-count").value;
        const riceTime = document.getElementById("rice-time").value;
        if (!riceCount || !riceTime) {
          alert("請填寫割稻飯人數與時間！");
          return;
        }
        formData.riceCount = riceCount;
        formData.riceTime = riceTime;
      }

      if (!document.getElementById("section-diy").classList.contains("hidden")) {
        const diyCount = document.getElementById("diy-count").value;
        const diyTime = document.getElementById("diy-time").value;
        if (!diyCount || !diyTime) {
          alert("請填寫 DIY 人數與時間！");
          return;
        }
        formData.diyCount = diyCount;
        formData.diyTime = diyTime;
      }

      fetch("https://script.google.com/macros/s/AKfycbw0XJU2dzQE5UpKLJyMO8z_kySblECjbw0-wnCRRrLmWfskqugW4nZoGYwnEpNZG4Kz/exec", {
        method: "POST",
        body: JSON.stringify(formData),
        headers: {
          "Content-Type": "application/json",
        }
      })
      .then(res => res.json())
      .then(response => {
        if (response.success) {
          if (formData.niucheCount && formData.niucheSlot) {
            arr[DATA][formData.niucheSlot] -= formData.niucheCount;
          }
          alert("預約成功！資料已儲存");
          checkTimeslots();
        } else {
          alert("提交失敗：" + response.error);
        }
      })
      .catch(error => {
        alert("網路錯誤或連線失敗！");
        console.error("錯誤:", error);
      });
    }
  </script>
</body>
</html>
